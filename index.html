<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Elektronik Paylaşım</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#0f172a;
  color:white;
}
header{
  background:#1e293b;
  padding:15px;
  text-align:center;
}
h1{color:#38bdf8;}

.post{
  background:#1e293b;
  margin:20px;
  padding:15px;
  border-radius:10px;
}
.post img{
  max-width:100%;
  border-radius:10px;
}

.comment{
  background:#0ea5e9;
  margin-top:5px;
  padding:5px;
  border-radius:5px;
}

#uploadBtn{
  position:fixed;
  bottom:20px;
  right:20px;
  width:60px;
  height:60px;
  border-radius:50%;
  font-size:30px;
  border:none;
  background:#38bdf8;
  cursor:pointer;
}
input{
  padding:5px;
  border-radius:5px;
  border:none;
}
</style>
</head>

<body>

<header>
<h1>Elektronik Paylaşım Platformu</h1>
</header>

<div id="posts"></div>

<input type="file" id="imageInput" accept="image/*" style="display:none">
<button id="uploadBtn">+</button>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>

const supabase = window.supabase.createClient(
  "https://tfniljopfegpruxqxdgg.supabase.co",
  "sb_publishable_EcpR3uHlFWUT_YkM6Pzplw_MdLCU4cB"
);

let username = localStorage.getItem("username");
if(!username){
  username = prompt("İsmini gir:");
  localStorage.setItem("username", username);
}

const postsDiv = document.getElementById("posts");

async function loadPosts(){
  const { data: posts } = await supabase
    .from("posts")
    .select("*")
    .order("created_at", { ascending: false });

  postsDiv.innerHTML = "";

  for(const post of posts){
    const { data: comments } = await supabase
      .from("comments")
      .select("*")
      .eq("post_id", post.id)
      .order("created_at");

    const div = document.createElement("div");
    div.className = "post";
    div.innerHTML = `
      <h3>${post.username}</h3>
      <img src="${post.image_url}">
      <div id="comments-${post.id}"></div>
      <input type="text" id="input-${post.id}" placeholder="Yorum yaz...">
      <button onclick="addComment(${post.id})">Gönder</button>
    `;

    postsDiv.appendChild(div);

    const commentDiv = document.getElementById("comments-"+post.id);
    comments.forEach(c=>{
      const cDiv = document.createElement("div");
      cDiv.className = "comment";
      cDiv.innerText = c.username + ": " + c.comment;
      commentDiv.appendChild(cDiv);
    });
  }
}

window.addComment = async function(postId){
  const input = document.getElementById("input-"+postId);
  if(input.value.trim() === "") return;

  await supabase.from("comments").insert({
    post_id: postId,
    username: username,
    comment: input.value
  });

  input.value = "";
  loadPosts();
}

document.getElementById("uploadBtn").onclick = ()=>{
  document.getElementById("imageInput").click();
}

document.getElementById("imageInput").onchange = async function(){
  const file = this.files[0];
  const fileName = Date.now() + "-" + file.name;

  await supabase.storage.from("images").upload(fileName, file);

  const { data } = supabase.storage.from("images").getPublicUrl(fileName);

  await supabase.from("posts").insert({
    username: username,
    image_url: data.publicUrl
  });

  loadPosts();
}

loadPosts();

</script>

</body>
</html>